这里把我们之前定下的「评论分页 & 子评论展开」策略快速回顾一下（就是现在要实现的准则）：

# 顶层评论（详情页主列表）

* **每页条数**：20
* **排序**：`created_at DESC, id DESC`（稳定排序，避免并列抖动）
* **翻页方式**：**cursor**（服务端返回 `next_cursor`；前端带上继续拉更旧的一页）
* **返回**：`items[]`, `has_more`, `next_cursor`，每条含 `replies_count`, `last_reply_at`, `like_count`, `unlike_count`

# 子评论（点"展开回复"时）

* **首次展开**：只拉 **3 条**（做预览）
* **继续展开**：每次 **10 条**
* **展示顺序**：前端按 **时间正序（ASC）** 展示，便于阅读

  * 实现口径：可以服务端按 `created_at DESC` 返回最近的3/10条，前端再**反转**呈现；继续加载用"上一页最旧一条"的位置做 **cursor** 拉更旧的
* **翻页隔离**：**每个父评论**维护各自的 `cursor/has_more`，互不影响
* **折叠规则**：预览 3 条之外显示"展开 N 条回复"；二级下再展开可见三级（最大到 3 层）

# 前端交互/性能

* **触底阈值**：列表滚动到**底部前 20%** 开始预取下一页（顶层和每个子列表都适用）
* **去重缓存**：用 `id` 去重；为顶层列表和每个父评论分别缓存已加载集合与 `cursor`
* **懒加载**：仅在用户点击"展开"时才请求该父评论的子列表

# 其他约束

* **最大层级**：`depth ≤ 3`
* **计数冗余**：依赖 `replies_count / last_reply_at`，避免前端聚合
* **接口上限**：服务端限制 `limit` 最大值（如 ≤50），防滥用

# uni-app 跨平台约束

* **禁用 DOM API**：不得使用 `focus()`, `blur()`, `scrollHeight`, `style` 等标准DOM方法
* **使用 uni-app 属性**：优先使用 `auto-focus`, `auto-height`, `focus` 等uni-app原生属性
* **平台兼容性**：代码必须在 H5、小程序、App 三端正常运行
* **条件编译**：平台差异使用 `#ifdef` 条件编译处理
* **API 替代**：DOM操作改用 `uni.createSelectorQuery()` 等uni-app API

需要的话，我可以把这两类接口的**请求/响应示例**（参数名、示例 JSON、错误码）写出来，直接当 API 合约用。

---

## 当前任务：轻量评论组件实现计划

### 阶段一 · 数据适配

| 目标 | 将 `/items/comments` 原始数据转换为组件消费格式 |
| --- | --- |
| 子任务 |
| 1. 定义 `CommentEntity`（`id`, `author`, `created_at`, `text`, `attachments`, `like_count`, `my_reaction`, `reply_count` 等） |
| 2. 编写 `mapCommentResponseToEntity`：
   * 解析 `author_id.*` 组装姓名头像
   * 根据 `attachments.directus_files_id.type` 分类为 image / video / audio / other
   * 预留 `my_reaction` 字段（后续接 reactions） |
| 3. 邻居详情页通过 adapter 保存 `commentsList` |
| 验证 |
| * 控制台打印转换结果，字段完整，无 `undefined`
* 多附件 / 空附件评论均正常 |

### 阶段二 · 轻量 CommentItem（展示）

| 目标 | 复刻 `CommentItem` 布局但只保留必要字段 |
| --- | --- |
| 子任务 |
| 1. 新建 `BasicCommentItem.vue`（头像、昵称、时间、正文、附件渲染、点赞数、回复按钮） |
| 2. 邻居详情页引用该组件列表展示 |
| 3. 组件 `emit('like')` 与 `emit('reply')`，父层暂时打印日志 |
| 验证 |
| * UI 与设计稿对齐
* 点赞/回复按钮冒泡事件触发
* 多媒体附件展示正常 |

### 阶段三 · 点赞交互

| 目标 | 接入 `comment_reactions` flow，实现点赞/取消 |
| --- | --- |
| 子任务 |
| 1. 调用 `POST /items/comment_reactions` / `DELETE` 完成点赞切换 |
| 2. 更新 adapter：根据 reactions 判断 `my_reaction`
| 3. 本地乐观更新 `like_count`，失败回滚并提示 |
| 验证 |
| * 点赞后 `like_count` +1，取消 -1
* 接口失败时状态回退并显示错误 |

### 阶段四 · 轻量回复输入框

| 目标 | 创建支持多媒体的轻量回复输入组件 |
| --- | --- |
| 整体策略 |
| * 分5个子阶段渐进式开发，每个子阶段独立验证
* 优先保证基础功能稳定，再逐步增加媒体功能
* 统一的文件上传和预览机制，便于扩展 |

#### 阶段四A · 基础文字回复

| 目标 | 实现纯文字回复输入框 |
| --- | --- |
| 子任务 |
| 1. 创建 `ReplyInput.vue` 组件（用户头像、文本框、提交按钮）
| 2. 支持回复模式：显示"回复 @用户名"提示条，可取消
| 3. 文本输入：自适应高度、字数统计（最大500字）、占位符
| 4. 提交逻辑：`POST /items/comments` 创建回复，乐观更新父评论
| 5. 集成到详情页：点击"回复"按钮显示输入框 |
| 约束条件 |
| * 组件代码控制在150行以内，保持轻量
* 必须支持取消回复功能，避免误操作
* 提交前验证：非空文本、字数限制、用户登录状态
* 提交失败时显示错误提示，不清空已输入内容
* **uni-app兼容**：禁用DOM API，使用auto-focus/auto-height等原生属性
* **跨平台测试**：确保H5、小程序、App三端正常运行 |
| 验证标准 |
| * 点击回复按钮弹出输入框，显示正确的回复目标
* 输入文字时字数统计实时更新，超限时禁用提交
* 提交成功后输入框消失，父评论replies_count+1
* 取消回复时输入框消失，已输入内容丢弃 |

#### 阶段四B · 表情功能

| 目标 | 添加表情选择和插入功能 |
| --- | --- |
| 子任务 |
| 1. 表情按钮：工具栏添加表情图标，点击弹出表情选择器
| 2. 表情选择器：网格布局显示常用emoji，点击插入到光标位置
| 3. 表情插入：支持光标位置插入，自动调整文本框高度
| 4. 交互优化：点击外部关闭选择器，表情按钮状态切换 |
| 约束条件 |
| * 表情库限制在20个常用emoji，避免选择困难
* 表情选择器高度不超过150px，支持滚动
* 光标位置处理使用uni-app兼容方案，避免DOM操作
* 移动端优化：表情按钮触摸区域不小于44px
* **跨平台兼容**：表情插入逻辑在所有平台正常工作 |
| 验证标准 |
| * 点击表情按钮弹出选择器，再次点击关闭
* 选择表情后正确插入到光标位置，选择器自动关闭
* 表情插入后文本框高度自适应，字数统计正确
* 点击输入框外部时表情选择器关闭 |

#### 阶段四C · 图片上传

| 目标 | 支持图片选择、预览和上传 |
| --- | --- |
| 子任务 |
| 1. 图片按钮：工具栏添加图片图标，点击调用选择器
| 2. 图片选择：支持相册选择和拍照，限制格式（jpg/png/gif）
| 3. 图片预览：缩略图展示，支持删除，最多3张图片
| 4. 图片上传：提交时先上传到Directus，获取文件ID
| 5. 进度反馈：上传过程显示进度，失败时可重试 |
| 约束条件 |
| * 单张图片大小限制5MB，总数限制3张
* 图片自动压缩：长边不超过1080px，质量80%
* 上传失败时保留本地预览，允许重新上传
* 预览区域高度固定，避免布局跳动
* **uni-app兼容**：使用uni.chooseImage()等原生API，避免Web File API |
| 验证标准 |
| * 选择图片后立即显示预览，可以删除重选
* 提交时显示上传进度，成功后创建评论
* 上传失败时显示错误信息，不清空其他内容
* 图片预览清晰，删除按钮易于操作 |

#### 阶段四D · 视频上传

| 目标 | 支持视频选择、预览和上传 |
| --- | --- |
| 子任务 |
| 1. 视频按钮：工具栏添加视频图标，点击调用选择器
| 2. 视频选择：支持相册选择和录制，限制格式（mp4/mov）
| 3. 视频预览：显示首帧缩略图和时长，支持播放预览
| 4. 视频上传：压缩处理后上传，显示上传进度
| 5. 互斥逻辑：视频和图片互斥，选择视频时清空图片 |
| 约束条件 |
| * 视频时长限制60秒，文件大小限制20MB
* 视频压缩：分辨率不超过720p，码率适中
* 只能选择1个视频，与图片功能互斥
* 预览播放时不自动播放，需用户主动点击
* **uni-app兼容**：使用uni.chooseVideo()等原生API，避免Web Video API |
| 验证标准 |
| * 选择视频后显示缩略图和时长信息
* 点击预览可以播放视频，控制正常
* 提交时视频上传成功，评论创建正确
* 视频和图片选择互斥，切换时有提示 |

#### 阶段四E · 语音录制（可选）

| 目标 | 支持语音录制、播放和上传 |
| --- | --- |
| 子任务 |
| 1. 语音按钮：长按录制，松开发送，上滑取消
| 2. 录制界面：显示录制时长、音量波形、取消提示
| 3. 语音预览：录制完成后可试听，支持重录
| 4. 语音上传：转换为适合的格式后上传
| 5. 权限处理：录音权限申请和错误处理 |
| 约束条件 |
| * 录音时长限制60秒，最短1秒
* 音频格式统一为mp3，采样率16kHz
* 必须处理权限被拒绝的情况
* 录制过程中禁用其他操作
* **uni-app兼容**：使用uni.getRecorderManager()，避免Web MediaRecorder API |
| 验证标准 |
| * 长按开始录制，界面反馈正确
* 录制完成后可以试听，音质清晰
* 上传成功后语音可以正常播放
* 权限被拒绝时显示友好提示 |

#### 阶段四 · 集成验证

| 目标 | 整体功能验证和优化 |
| --- | --- |
| 验证项目 |
| * 所有媒体类型都能正确上传和显示
* 回复创建后父评论状态正确更新
* 组件在不同设备和平台上表现一致
* 错误处理完善，用户体验流畅
* **跨平台验证**：H5、微信小程序、App端功能完全一致
* **性能验证**：无DOM API错误，无平台兼容性问题 |

### 阶段五 · 分页 / 懒加载（延续原分页策略）

依照前述顶层 cursor + 子评论懒加载设计，在基础功能稳定后迭代。

> 完成每个阶段后请更新本文档并在调试面板记录验证步骤，方便团队跟进。