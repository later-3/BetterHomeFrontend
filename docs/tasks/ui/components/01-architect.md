太棒了，我们就按“先定框架、再逐层细化”的方式来。先给你一份**讨论计划（路线图）**——每一章产出物都很明确，走完即得到完整方案。今天先只给计划，不展开细节；你确认后我们从第 0 步开始推进。

# 讨论计划（Roadmap）

1. 目标与边界对齐（Step 0）

   * 明确：支持的评论深度（1/2/3 级）、媒体约束（每条至多 1 图/1 视/1 音 + 文本）、默认展示规则（仅一级显示、二级点击展开、三级不缩进）、排序（最新/最热）、操作（点赞、pass 的语义）、权限（谁能删/审/置顶）、防滥用（频率限制、拉黑、屏蔽词）。
   * 产出：一张“行为规则清单 + 术语定义”（含“pass”的准确含义）。

2. 关键用户流 & 交互原则（Step 1）

   * 详情页评论区、时间轴节点评论区：浏览/展开/收起/发布/回复/删除/举报/点赞/撤回等主流程。
   * 媒体交互：图片预览、视频点播（非自动）、音频播放（互斥）与错误兜底。
   * 产出：交互规约 + 空态/加载/错误态清单 + 乐观更新策略。

3. 数据模型（Directus）设计（Step 2）

   * 表/集合：`comments`（parent\_id/root\_id/depth/target\_type/target\_id）、`comment_reactions`（like/pass）、附件字段设计（内联 vs 关联）、计数冗余（replies\_count/likes\_count）、索引策略。
   * 权限：基于角色/拥有者的读写删；审核/屏蔽字段。
   * 产出：ER 图 + 字段字典 + 索引与权限策略。

4. API 合约 & 分页策略（Step 3）

   * 列表：顶层评论分页（附 `replies_count` 汇总）；子评分页（点击展开再取）；三级回复作为二级的“回复流”返回。
   * 写入：创建/删除/点赞/取消赞/pass/取消 pass；幂等键、去重、速率限制。
   * 排序：按时间/热度切换方案；时间轴节点与帖子公用接口的差异化参数。
   * 产出：REST/GraphQL 合约文档（请求/响应样例）+ 分页/游标规范。

5. 前端组件划分（Step 4）

   * 容器层：`CommentContainer`（接入数据、分页、展开状态、统一暂停媒体）。
   * 列表 & 单元：`CommentList`（顶层分页）＋ `CommentItem`（递归到 2 级；3 级以内联“@xxx 回复”不再缩进）。
   * 交互子件：`CommentComposer`（文本+单媒体上传）、`ReactionBar`（like/pass）、`MediaImage`/`VideoCard`/`AudioPlayer`。
   * 状态：Pinia 模块（按 target 维度的评论状态、展开态、乐观队列、播放互斥复用）。
   * 产出：组件职责矩阵（谁管数据、谁管展示、谁发事件、谁消费事件）+ 状态图。

6. 性能与体验基线（Step 5）

   * 分页/懒加载、骨架屏、错误兜底；图片缩略图与原图预览；视频/音频 `preload=none`；同屏互斥播放；缓存与回流控制。
   * 大量评论时的“按需加载子评”/“展开再拉”策略；去抖/节流。
   * 产出：性能 SLO & 对策清单（可度量指标 + 埋点位）。

7. 内容安全与治理（Step 6）

   * 文本净化（XSS/关键词）、媒体扩展名/尺寸限制、举报/拉黑、后台审核流；删除的“墓碑态”展示。
   * 产出：治理策略文档 + 前后端分工表。

8. 验收清单与里程碑（Step 7）

   * MVP 覆盖范围、可选增强（热度排序、引用回复、消息提醒）、联调自测清单。
   * 产出：交付验收表 + 后续迭代路线。

---

如果这份计划 OK，我们从 **Step 0：目标与边界对齐** 开始。我会先列出需要一锤定音的 10 个小问题（比如 “pass 的确切含义/展示”、“顶层排序默认值”、“是否允许编辑/撤回”等），你逐项拍板，我们再进入数据模型与 API。
