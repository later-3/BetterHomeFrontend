# é‡æ–°åˆ›å»ºè´¢åŠ¡è¡¨å¿«é€ŸæŒ‡å—

## é—®é¢˜èƒŒæ™¯

åœ¨ Directus Admin ä¸­ï¼Œ`expenses` å’Œ `employees` è¡¨æ˜¾ç¤ºä¸ºæ–‡ä»¶å¤¹å›¾æ ‡ï¼Œå·²è¢«åˆ é™¤ã€‚éœ€è¦æ ¹æ® `finance-schema-v2.dbml` é‡æ–°åˆ›å»ºè¿™ä¸¤ä¸ªè¡¨ã€‚

## å¿«é€Ÿåˆ›å»º

### æ–¹æ³• 1: æ‰¹é‡åˆ›å»ºï¼ˆæ¨èï¼‰

ä¸€æ¬¡æ€§åˆ›å»ºä¸¤ä¸ªè¡¨ï¼š

```bash
# 1. è®¾ç½®ç®¡ç†å‘˜ token
export DIRECTUS_ADMIN_TOKEN="your_admin_token_here"

# 2. æ‰¹é‡åˆ›å»º
bash scripts/create-expenses-and-employees.sh
```

### æ–¹æ³• 2: å•ç‹¬åˆ›å»º

åˆ†åˆ«åˆ›å»ºæ¯ä¸ªè¡¨ï¼š

```bash
# è®¾ç½® token
export DIRECTUS_ADMIN_TOKEN="your_admin_token_here"

# åˆ›å»º expenses è¡¨
bash scripts/create-expenses-table.sh

# åˆ›å»º employees è¡¨
bash scripts/create-employees-table.sh
```

## è¡¨ç»“æ„æ¦‚è§ˆ

### Expenses è¡¨ï¼ˆæ”¯å‡ºè®°å½•ï¼‰

**å›¾æ ‡**: ğŸ’³ (payments)  
**å­—æ®µæ•°**: 22 ä¸ªï¼ˆ4ä¸ªå®¡è®¡å­—æ®µ + 18ä¸ªä¸šåŠ¡å­—æ®µï¼‰

**æ ¸å¿ƒå­—æ®µ**:
- `community_id` - æ‰€å±ç¤¾åŒºï¼ˆå¿…å¡«ï¼‰
- `expense_type` - æ”¯å‡ºç±»å‹ï¼ˆå¿…å¡«ï¼‰
  - salaryï¼ˆå‘˜å·¥å·¥èµ„ï¼‰
  - maintenanceï¼ˆè®¾æ–½ç»´æŠ¤ï¼‰
  - utilitiesï¼ˆå…¬å…±èƒ½è€—ï¼‰
  - materialsï¼ˆè€—æé‡‡è´­ï¼‰
  - activityï¼ˆç¤¾åŒºæ´»åŠ¨ï¼‰
  - committee_fundï¼ˆä¸šå§”ä¼šç»è´¹ï¼‰
  - maintenance_fundï¼ˆç»´ä¿®åŸºé‡‘ä½¿ç”¨ï¼‰
  - otherï¼ˆå…¶ä»–ï¼‰
- `title` - æ”¯å‡ºæ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰
- `amount` - æ”¯å‡ºé‡‘é¢ï¼ˆå¿…å¡«ï¼‰
- `paid_at` - æ”¯ä»˜æ—¶é—´ï¼ˆå¿…å¡«ï¼‰
- `payment_method` - æ”¯ä»˜æ–¹å¼ï¼ˆå¿…å¡«ï¼‰
- `status` - å®¡æ ¸çŠ¶æ€ï¼ˆé»˜è®¤ approvedï¼‰
- `created_by` - åˆ›å»ºäººï¼ˆå¿…å¡«ï¼‰

**å…³ç³»**:
- `community_id` â†’ `communities`
- `created_by` â†’ `directus_users`
- `approved_by` â†’ `directus_users`

---

### Employees è¡¨ï¼ˆå‘˜å·¥ä¿¡æ¯ï¼‰

**å›¾æ ‡**: ğŸ« (badge)  
**å­—æ®µæ•°**: 17 ä¸ªï¼ˆ4ä¸ªå®¡è®¡å­—æ®µ + 13ä¸ªä¸šåŠ¡å­—æ®µï¼‰

**æ ¸å¿ƒå­—æ®µ**:
- `community_id` - æ‰€å±ç¤¾åŒºï¼ˆå¿…å¡«ï¼‰
- `name` - å‘˜å·¥å§“åï¼ˆå¿…å¡«ï¼‰
- `phone` - è”ç³»ç”µè¯
- `id_card_last4` - èº«ä»½è¯å4ä½ï¼ˆéšç§ä¿æŠ¤ï¼‰
- `position_type` - å²—ä½ç±»å‹ï¼ˆå¿…å¡«ï¼‰
  - securityï¼ˆä¿å®‰ï¼‰
  - cleaningï¼ˆä¿æ´ï¼‰
  - managementï¼ˆç®¡ç†äººå‘˜ï¼‰
  - electricianï¼ˆæ°´ç”µå·¥ï¼‰
  - plumberï¼ˆç®¡é“å·¥ï¼‰
  - gardenerï¼ˆç»¿åŒ–å·¥ï¼‰
  - temp_workerï¼ˆä¸´æ—¶å·¥ï¼‰
  - otherï¼ˆå…¶ä»–ï¼‰
- `position_title` - å²—ä½åç§°ï¼ˆå¦‚ï¼šä¿å®‰é˜Ÿé•¿ï¼‰
- `employment_status` - åœ¨èŒçŠ¶æ€ï¼ˆé»˜è®¤ activeï¼‰
  - activeï¼ˆåœ¨èŒï¼‰
  - resignedï¼ˆç¦»èŒï¼‰
  - on_leaveï¼ˆä¼‘å‡ï¼‰
  - suspendedï¼ˆåœèŒï¼‰
- `hire_date` - å…¥èŒæ—¥æœŸï¼ˆå¿…å¡«ï¼‰
- `resignation_date` - ç¦»èŒæ—¥æœŸ
- `base_salary` - åŸºæœ¬å·¥èµ„

**å…³ç³»**:
- `community_id` â†’ `communities`

## éªŒè¯æ¸…å•

åˆ›å»ºå®Œæˆåï¼Œä½¿ç”¨æ­¤æ¸…å•éªŒè¯ï¼š

### âœ… Directus Admin éªŒè¯

**Expenses è¡¨**:
- [ ] è¡¨å›¾æ ‡æ˜¾ç¤ºä¸º ğŸ’³ (payments)
- [ ] å¯ä»¥ç‚¹å‡»è¿›å…¥æŸ¥çœ‹æ•°æ®
- [ ] å­—æ®µåˆ—è¡¨å®Œæ•´ï¼ˆ22ä¸ªå­—æ®µï¼‰
- [ ] å¯ä»¥åˆ›å»ºæ–°è®°å½•
- [ ] æ”¯å‡ºç±»å‹ä¸‹æ‹‰é€‰é¡¹æ­£ç¡®ï¼ˆ8ä¸ªé€‰é¡¹ï¼‰
- [ ] æ”¯ä»˜æ–¹å¼ä¸‹æ‹‰é€‰é¡¹æ­£ç¡®ï¼ˆ6ä¸ªé€‰é¡¹ï¼‰
- [ ] å®¡æ ¸çŠ¶æ€ä¸‹æ‹‰é€‰é¡¹æ­£ç¡®ï¼ˆ3ä¸ªé€‰é¡¹ï¼‰

**Employees è¡¨**:
- [ ] è¡¨å›¾æ ‡æ˜¾ç¤ºä¸º ğŸ« (badge)
- [ ] å¯ä»¥ç‚¹å‡»è¿›å…¥æŸ¥çœ‹æ•°æ®
- [ ] å­—æ®µåˆ—è¡¨å®Œæ•´ï¼ˆ17ä¸ªå­—æ®µï¼‰
- [ ] å¯ä»¥åˆ›å»ºæ–°è®°å½•
- [ ] å²—ä½ç±»å‹ä¸‹æ‹‰é€‰é¡¹æ­£ç¡®ï¼ˆ8ä¸ªé€‰é¡¹ï¼‰
- [ ] åœ¨èŒçŠ¶æ€ä¸‹æ‹‰é€‰é¡¹æ­£ç¡®ï¼ˆ4ä¸ªé€‰é¡¹ï¼‰

### âœ… æµ‹è¯•æ•°æ®åˆ›å»º

**åˆ›å»ºæµ‹è¯•æ”¯å‡ºè®°å½•**:
```json
{
  "community_id": "<your_community_id>",
  "expense_type": "utilities",
  "title": "2024å¹´1æœˆç”µè´¹",
  "description": "å°åŒºå…¬å…±åŒºåŸŸç”µè´¹",
  "amount": 5000.00,
  "paid_at": "2024-01-15T10:00:00",
  "period": "2024-01",
  "payment_method": "bank",
  "status": "approved",
  "created_by": "<your_user_id>"
}
```

**åˆ›å»ºæµ‹è¯•å‘˜å·¥è®°å½•**:
```json
{
  "community_id": "<your_community_id>",
  "name": "å¼ ä¸‰",
  "phone": "13800138000",
  "position_type": "security",
  "position_title": "ä¿å®‰é˜Ÿé•¿",
  "employment_status": "active",
  "hire_date": "2024-01-01",
  "base_salary": 5000.00
}
```

### âœ… æƒé™é…ç½®

```bash
# é…ç½® resident è§’è‰²æƒé™
bash scripts/fix-resident-billing-permissions.sh
```

éªŒè¯æƒé™ï¼š
- [ ] Resident å¯ä»¥è¯»å– expensesï¼ˆstatus=approvedï¼‰
- [ ] Resident å¯ä»¥è¯»å– employeesï¼ˆå²—ä½ç»Ÿè®¡ï¼‰
- [ ] Resident ä¸èƒ½è¯»å–å‘˜å·¥çš„æ•æ„Ÿä¿¡æ¯ï¼ˆå·¥èµ„ï¼‰

### âœ… åº”ç”¨æµ‹è¯•

- [ ] ç™»å½•åº”ç”¨
- [ ] è®¿é—® Profile â†’ æŸ¥çœ‹å°åŒºæ”¶æ”¯æƒ…å†µ
- [ ] è´¢åŠ¡æ€»è§ˆé¡µé¢æ˜¾ç¤ºæ­£å¸¸
- [ ] æ”¯å‡ºæ•°æ®æ˜¾ç¤ºæ­£ç¡®
- [ ] æ”¯å‡ºåˆ†ç±»æ˜¾ç¤ºæ­£ç¡®
- [ ] å¯ä»¥æŸ¥çœ‹æ”¯å‡ºæ˜ç»†

## å¸¸è§é—®é¢˜

### Q1: è„šæœ¬æ‰§è¡ŒæŠ¥é”™ "Collection already exists"

**åŸå› **: è¡¨å·²ç»å­˜åœ¨

**è§£å†³æ–¹æ³•**:
1. åœ¨ Directus Admin ä¸­æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
2. å¦‚æœå­˜åœ¨ä½†æ˜¾ç¤ºä¸ºæ–‡ä»¶å¤¹ï¼Œå…ˆåˆ é™¤
3. é‡æ–°è¿è¡Œè„šæœ¬

### Q2: å­—æ®µåˆ›å»ºå¤±è´¥

**åŸå› **: æŸäº›å­—æ®µå¯èƒ½å·²å­˜åœ¨

**è§£å†³æ–¹æ³•**:
1. åœ¨ Directus Admin ä¸­æ£€æŸ¥å­—æ®µåˆ—è¡¨
2. æ‰‹åŠ¨åˆ é™¤å†²çªçš„å­—æ®µ
3. é‡æ–°è¿è¡Œè„šæœ¬

### Q3: å…³ç³»åˆ›å»ºå¤±è´¥

**åŸå› **: å…³è”è¡¨ä¸å­˜åœ¨

**è§£å†³æ–¹æ³•**:
1. ç¡®ä¿ `communities` è¡¨å­˜åœ¨
2. ç¡®ä¿ `directus_users` è¡¨å­˜åœ¨
3. æ£€æŸ¥å­—æ®µç±»å‹æ˜¯å¦ä¸º uuid

### Q4: è¡¨åˆ›å»ºæˆåŠŸä½†ä»æ˜¾ç¤ºä¸ºæ–‡ä»¶å¤¹

**åŸå› **: æµè§ˆå™¨ç¼“å­˜

**è§£å†³æ–¹æ³•**:
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. ä½¿ç”¨æ— ç—•æ¨¡å¼è®¿é—®
3. å¼ºåˆ¶åˆ·æ–°ï¼ˆCtrl+Shift+Rï¼‰

### Q5: åº”ç”¨ä¸­çœ‹ä¸åˆ°æ•°æ®

**æ£€æŸ¥é¡¹**:
1. æƒé™æ˜¯å¦é…ç½®æ­£ç¡®
2. æ˜¯å¦æœ‰æµ‹è¯•æ•°æ®
3. æ•°æ®çš„ status æ˜¯å¦ä¸º approved
4. ç”¨æˆ·çš„ community_id æ˜¯å¦åŒ¹é…

**è§£å†³æ–¹æ³•**:
```bash
# è¯Šæ–­æƒé™
bash scripts/diagnose-billing-permissions.sh

# ä¿®å¤æƒé™
bash scripts/fix-resident-billing-permissions.sh
```

## è„šæœ¬æ–‡ä»¶è¯´æ˜

### å•ç‹¬åˆ›å»ºè„šæœ¬

1. **`scripts/create-expenses-table.sh`**
   - åˆ›å»º expenses è¡¨
   - 22 ä¸ªå­—æ®µ
   - 3 ä¸ªå…³ç³»
   - å®Œæ•´çš„ meta é…ç½®

2. **`scripts/create-employees-table.sh`**
   - åˆ›å»º employees è¡¨
   - 17 ä¸ªå­—æ®µ
   - 1 ä¸ªå…³ç³»
   - å®Œæ•´çš„ meta é…ç½®

### æ‰¹é‡åˆ›å»ºè„šæœ¬

**`scripts/create-expenses-and-employees.sh`**
- ä¸€æ¬¡æ€§åˆ›å»ºä¸¤ä¸ªè¡¨
- è‡ªåŠ¨è°ƒç”¨å•ç‹¬çš„åˆ›å»ºè„šæœ¬
- æä¾›å®Œæ•´çš„æ“ä½œæŒ‡å¼•

## ç›¸å…³æ–‡æ¡£

- [è´¢åŠ¡è¡¨ç»“æ„è®¾è®¡](./finance-schema-v2.dbml) - å®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰
- [Expenses è¡¨è¯¦ç»†æŒ‡å—](./recreate-expenses-guide.md) - Expenses è¡¨çš„è¯¦ç»†è¯´æ˜
- [æƒé™é…ç½®æŒ‡å—](./permission-troubleshooting.md) - æƒé™é…ç½®å’Œæ•…éšœæ’é™¤
- [è´¢åŠ¡åŠŸèƒ½è®¾è®¡æ–‡æ¡£](./design.md) - æ•´ä½“è®¾è®¡æ–‡æ¡£

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# è®¾ç½® token
export DIRECTUS_ADMIN_TOKEN="your_token"

# æ‰¹é‡åˆ›å»ºï¼ˆæ¨èï¼‰
bash scripts/create-expenses-and-employees.sh

# å•ç‹¬åˆ›å»º expenses
bash scripts/create-expenses-table.sh

# å•ç‹¬åˆ›å»º employees
bash scripts/create-employees-table.sh

# é…ç½®æƒé™
bash scripts/fix-resident-billing-permissions.sh

# è¯Šæ–­æƒé™
bash scripts/diagnose-billing-permissions.sh

# éªŒè¯è¡¨ç»“æ„
bash scripts/check-expenses-collection.sh
```

## æ—¶é—´ä¼°ç®—

- è®¾ç½® token: 1 åˆ†é’Ÿ
- è¿è¡Œæ‰¹é‡åˆ›å»ºè„šæœ¬: 2-3 åˆ†é’Ÿ
- éªŒè¯è¡¨ç»“æ„: 2 åˆ†é’Ÿ
- åˆ›å»ºæµ‹è¯•æ•°æ®: 3 åˆ†é’Ÿ
- é…ç½®æƒé™: 2 åˆ†é’Ÿ
- åº”ç”¨æµ‹è¯•: 3 åˆ†é’Ÿ

**æ€»è®¡**: çº¦ 15 åˆ†é’Ÿ

## æˆåŠŸæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹å†…å®¹æ—¶ï¼Œè¯´æ˜åˆ›å»ºæˆåŠŸï¼š

âœ… åœ¨ Directus Admin ä¸­ï¼š
- Expenses æ˜¾ç¤ºä¸º ğŸ’³ å›¾æ ‡
- Employees æ˜¾ç¤ºä¸º ğŸ« å›¾æ ‡
- å¯ä»¥æ­£å¸¸åˆ›å»ºå’Œç¼–è¾‘è®°å½•

âœ… åœ¨åº”ç”¨ä¸­ï¼š
- è´¢åŠ¡æ€»è§ˆé¡µé¢æ˜¾ç¤ºæ­£å¸¸
- æ”¯å‡ºæ•°æ®æ­£ç¡®æ˜¾ç¤º
- æ”¯å‡ºåˆ†ç±»æ­£ç¡®

âœ… æƒé™æ­£å¸¸ï¼š
- Resident å¯ä»¥æŸ¥çœ‹å·²å®¡æ ¸çš„æ”¯å‡º
- Resident å¯ä»¥æŸ¥çœ‹å‘˜å·¥å²—ä½ç»Ÿè®¡
- æ•°æ®è¿‡æ»¤æ­£ç¡®ï¼ˆåªçœ‹è‡ªå·±ç¤¾åŒºçš„æ•°æ®ï¼‰
