# 财务数据生成指南

## 脚本说明

`scripts/generate-finance-data.js` 是一个 Node.js 脚本，用于自动生成兰亭雅苑的完整财务数据。

## 使用方法

### 方法1: 使用环境变量

```bash
DIRECTUS_TOKEN="sfXUxkm3bEwOKO8fDKrZoClDQ4N08D0n" node scripts/generate-finance-data.js
```

### 方法2: 使用命令行参数

```bash
node scripts/generate-finance-data.js --token="sfXUxkm3bEwOKO8fDKrZoClDQ4N08D0n"
```

## 生成的数据

### 时间范围
- **2024年7月 - 2024年12月**（6个月）

### 数据类型和数量

| 数据类型 | 数量 | 说明 |
|---------|------|------|
| 员工信息 | 5人 | 保安2人、保洁2人、经理1人 |
| 物业费账单 | 72条 | 12户 × 6个月 |
| 物业费收款 | ~60条 | 85%缴费率 |
| 公共收益 | ~33条 | 每月5-6条 |
| 工资记录 | 30条 | 5人 × 6个月 |
| 支出记录 | ~54条 | 工资支出6条 + 其他支出48条 |
| 维修基金账户 | 12个 | 每户一个 |
| 维修基金缴纳 | 12条 | 首次缴纳 |

**总计**: 约 **278 条记录**

## 数据设计详情

### 1. 员工（5人）

| 姓名 | 岗位 | 职位 | 工资 |
|-----|------|------|------|
| 张三 | 保安 | 保安队长 | 5,500元/月 |
| 李四 | 保安 | 保安队员 | 4,500元/月 |
| 王五 | 保洁 | 保洁 | 4,000元/月 |
| 赵六 | 保洁 | 保洁 | 4,000元/月 |
| 孙七 | 管理 | 物业经理 | 5,000元/月 |

**总工资**: 23,000元/月

### 2. 物业费账单

- **单价**: 4.0元/㎡
- **面积范围**: 60-120㎡（随机）
- **应缴金额**: 面积 × 单价
- **缴费率**: 85%
- **状态**: 85%为 paid（已缴），15%为 unpaid（未缴）

**月度收入**: 约 4,320元（12户 × 平均90㎡ × 4.0元）

### 3. 公共收益

每月5-6条记录，类型包括：
- 临时停车收益: 4,000-6,000元
- 月租车位收益: 3,000-5,000元
- 电梯广告收益: 1,500-2,500元
- 门禁广告收益: 800-1,200元
- 会议室租赁: 500-1,500元
- 快递柜分成: 800-1,200元

**月度收入**: 8,000-12,000元

### 4. 支出记录

#### 工资支出（每月1条）
- 金额: 23,000元
- 包含所有员工的工资总和

#### 其他支出（每月4-6条）
- 电费: 5,000-8,000元
- 水费: 2,000-3,000元
- 电梯维护: 2,000-4,000元
- 绿化养护: 1,500-2,500元
- 清洁用品: 1,000-2,000元
- 办公用品: 500-1,000元

**月度支出**: 34,000-39,000元

### 5. 工资记录

每个员工每月一条记录，包含：
- 基本工资
- 奖金（0-500元随机）
- 补贴（0-200元随机）
- 社保（基本工资的10%）
- 公积金（基本工资的8%）
- 实发金额 = 基本工资 + 奖金 + 补贴 - 社保 - 公积金

### 6. 维修基金

- **首次缴纳标准**: 100元/㎡
- **账户余额**: 房屋面积 × 100元
- **总金额**: 约 108,000元（12户 × 平均90㎡ × 100元）

## 收支分析

### 月度收支（平均）

| 项目 | 金额 |
|-----|------|
| 物业费收入 | 4,320元 |
| 公共收益 | 10,000元 |
| **总收入** | **14,320元** |
| 员工工资 | 23,000元 |
| 公共能耗 | 7,000元 |
| 设施维护 | 3,000元 |
| 耗材采购 | 1,500元 |
| **总支出** | **34,500元** |
| **结余** | **-20,180元** |

**说明**: 小区规模较小（仅12户），物业费收入不足以覆盖运营成本，属于正常情况。实际运营中可能需要：
1. 提高物业费单价
2. 增加公共收益
3. 减少人员配置
4. 或由开发商补贴

## 脚本执行流程

1. ✅ 获取业主列表（12户）
2. ✅ 创建员工信息（5人）
3. ✅ 创建物业费账单（72条）
4. ✅ 创建物业费收款记录（~60条）
5. ✅ 创建公共收益（~33条）
6. ✅ 创建工资记录和支出（30条工资 + 6条支出）
7. ✅ 创建其他支出（~48条）
8. ✅ 创建维修基金账户（12个）
9. ✅ 创建维修基金缴纳记录（12条）

**预计执行时间**: 3-5分钟

## 注意事项

### 1. 前置条件
- ✅ Node.js 已安装
- ✅ Directus 服务正常运行
- ✅ 有效的管理员 token
- ✅ 兰亭雅苑社区存在
- ✅ 业主数据存在

### 2. 数据安全
- ⚠️ 脚本会创建大量数据，建议先在测试环境运行
- ⚠️ 如果需要重新生成，请先删除旧数据
- ⚠️ 建议在运行前备份数据库

### 3. 错误处理
- 脚本会自动跳过失败的记录
- 每个步骤都有错误提示
- 如果某个步骤完全失败，会显示详细错误信息

### 4. 性能优化
- 每个请求之间有延迟（50-100ms）
- 避免请求过快导致服务器压力
- 大约需要3-5分钟完成

## 验证数据

### 1. 在 Directus Admin 中验证

访问 `http://localhost:8055/admin`，检查：

- [ ] Content → Employees（5条记录）
- [ ] Content → Billings（72条记录）
- [ ] Content → Billing Payments（~60条记录）
- [ ] Content → Incomes（~33条记录）
- [ ] Content → Expenses（~54条记录）
- [ ] Content → Salary Records（30条记录）
- [ ] Content → Maintenance Fund Accounts（12条记录）
- [ ] Content → Maintenance Fund Payments（12条记录）

### 2. 数据一致性检查

运行验证脚本：

```bash
bash scripts/verify-finance-data.sh
```

检查项：
- [ ] 每个月都有数据
- [ ] 账单的 paid_amount 与收款记录匹配
- [ ] 工资记录关联到支出记录
- [ ] 维修基金账户余额正确

### 3. 在应用中测试

使用业主账号登录（如 user01@test.com），测试：

- [ ] 查看我的物业费账单
- [ ] 查看缴费记录
- [ ] 查看小区收支情况
- [ ] 查看公共收益明细
- [ ] 查看支出明细
- [ ] 查看维修基金账户

## 常见问题

### Q1: 脚本执行失败怎么办？

**A**: 检查以下几点：
1. Token 是否有效
2. Directus 服务是否运行
3. 网络连接是否正常
4. 查看错误信息，定位具体问题

### Q2: 如何重新生成数据？

**A**: 
1. 在 Directus Admin 中删除旧数据
2. 重新运行脚本

或者使用清理脚本：
```bash
bash scripts/clean-finance-data.sh
```

### Q3: 可以修改数据参数吗？

**A**: 可以！编辑 `scripts/generate-finance-data.js`，修改 CONFIG 部分：

```javascript
const CONFIG = {
  START_MONTH: '2024-07',  // 修改开始月份
  END_MONTH: '2024-12',    // 修改结束月份
  UNIT_PRICE: 4.0,         // 修改物业费单价
  PAYMENT_RATE: 0.85,      // 修改缴费率
  // ...
};
```

### Q4: 数据生成后如何配置权限？

**A**: 运行权限配置脚本：

```bash
bash scripts/fix-resident-billing-permissions.sh
```

### Q5: 如何添加维修基金使用记录？

**A**: 维修基金使用需要关联工单，建议手动创建：
1. 创建工单（类型：maintenance_fund_application）
2. 创建维修基金使用记录
3. 业委会审批
4. 创建支出记录

## 下一步操作

数据生成完成后：

1. **配置权限**
   ```bash
   bash scripts/fix-resident-billing-permissions.sh
   ```

2. **验证数据**
   - 在 Directus Admin 中检查
   - 在应用中测试各项功能

3. **调整数据**（如果需要）
   - 修改某些记录的金额
   - 添加更多测试数据
   - 创建维修基金使用记录

4. **开始开发/演示**
   - 数据已就绪，可以开始功能开发
   - 或用于产品演示

## 相关文档

- [财务数据模拟方案](./finance-simulation-plan.md)
- [权限配置指南](./permission-troubleshooting.md)
- [财务功能设计文档](./design.md)
