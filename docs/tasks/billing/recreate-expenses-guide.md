# é‡æ–°åˆ›å»º Expenses è¡¨æŒ‡å—

## èƒŒæ™¯

ä¹‹å‰çš„ expenses è¡¨æ˜¾ç¤ºä¸ºæ–‡ä»¶å¤¹ï¼Œå·²è¢«åˆ é™¤ã€‚ç°åœ¨éœ€è¦æ ¹æ® `finance-schema-v2.dbml` é‡æ–°åˆ›å»ºæ­£ç¡®çš„ expenses è¡¨ã€‚

## è¡¨ç»“æ„è¯´æ˜

æ ¹æ® DBML è®¾è®¡æ–‡æ¡£ï¼Œexpenses è¡¨åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

### å­—æ®µåˆ—è¡¨ï¼ˆå…± 22 ä¸ªå­—æ®µï¼‰

#### å®¡è®¡å­—æ®µï¼ˆ4ä¸ªï¼‰
- `user_created` - åˆ›å»ºç”¨æˆ·
- `date_created` - åˆ›å»ºæ—¶é—´
- `user_updated` - æ›´æ–°ç”¨æˆ·
- `date_updated` - æ›´æ–°æ—¶é—´

#### æ”¯å‡ºåŸºæœ¬ä¿¡æ¯ï¼ˆ5ä¸ªï¼‰
- `community_id` - æ‰€å±ç¤¾åŒºï¼ˆå¿…å¡«ï¼‰
- `expense_type` - æ”¯å‡ºç±»å‹ï¼ˆå¿…å¡«ï¼Œæšä¸¾ï¼‰
  - salaryï¼ˆå‘˜å·¥å·¥èµ„ï¼‰
  - maintenanceï¼ˆè®¾æ–½ç»´æŠ¤ï¼‰
  - utilitiesï¼ˆå…¬å…±èƒ½è€—ï¼‰
  - materialsï¼ˆè€—æé‡‡è´­ï¼‰
  - activityï¼ˆç¤¾åŒºæ´»åŠ¨ï¼‰
  - committee_fundï¼ˆä¸šå§”ä¼šç»è´¹ï¼‰
  - maintenance_fundï¼ˆç»´ä¿®åŸºé‡‘ä½¿ç”¨ï¼‰
  - otherï¼ˆå…¶ä»–ï¼‰
- `title` - æ”¯å‡ºæ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰
- `description` - è¯¦ç»†è¯´æ˜
- `amount` - æ”¯å‡ºé‡‘é¢ï¼ˆå¿…å¡«ï¼Œdecimal(10,2)ï¼‰

#### æ”¯ä»˜ä¿¡æ¯ï¼ˆ3ä¸ªï¼‰
- `paid_at` - æ”¯ä»˜æ—¶é—´ï¼ˆå¿…å¡«ï¼‰
- `period` - æ‰€å±æœˆä»½ï¼ˆYYYY-MMï¼Œç”¨äºæœˆåº¦æ±‡æ€»ï¼‰
- `payment_method` - æ”¯ä»˜æ–¹å¼ï¼ˆå¿…å¡«ï¼Œæšä¸¾ï¼‰
  - wechatï¼ˆå¾®ä¿¡ï¼‰
  - alipayï¼ˆæ”¯ä»˜å®ï¼‰
  - bankï¼ˆé“¶è¡Œè½¬è´¦ï¼‰
  - cashï¼ˆç°é‡‘ï¼‰
  - posï¼ˆPOSæœºåˆ·å¡ï¼‰
  - otherï¼ˆå…¶ä»–ï¼‰

#### åˆ†ç±»å’Œå…³è”ï¼ˆ2ä¸ªï¼‰
- `category` - ç»†åˆ†ç±»åˆ«ï¼ˆå¦‚ï¼šå·¥èµ„-ä¿å®‰ã€ç»´æŠ¤-ç”µæ¢¯ï¼‰
- `related_info` - å…³è”ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰
  - å·¥èµ„ï¼š`{"salary_record_ids": ["uuid1", "uuid2"]}`
  - ç»´ä¿®åŸºé‡‘ï¼š`{"mf_usage_id": "uuid"}`
  - ç»´æŠ¤ï¼š`{"contractor": "XXå…¬å¸", "contract_no": "MNT202401"}`

#### å®¡æ ¸æµç¨‹ï¼ˆ3ä¸ªï¼‰
- `status` - å®¡æ ¸çŠ¶æ€ï¼ˆå¿…å¡«ï¼Œé»˜è®¤ approvedï¼‰
  - pendingï¼ˆå¾…å®¡æ ¸ï¼‰
  - approvedï¼ˆå·²å®¡æ ¸ï¼‰
  - rejectedï¼ˆå·²æ‹’ç»ï¼‰
- `approved_by` - å®¡æ‰¹äºº
- `approved_at` - å®¡æ‰¹æ—¶é—´

#### å‡­è¯å’Œå¤‡æ³¨ï¼ˆ2ä¸ªï¼‰
- `proof_files` - å‡­è¯æ–‡ä»¶IDæ•°ç»„ï¼ˆJSONï¼‰
- `notes` - å¤‡æ³¨

#### å…¶ä»–ï¼ˆ3ä¸ªï¼‰
- `created_by` - åˆ›å»ºäºº/å½•å…¥äººï¼ˆå¿…å¡«ï¼‰
- `date_deleted` - è½¯åˆ é™¤æ—¶é—´

### è¡¨å…³ç³»ï¼ˆ3ä¸ªï¼‰

1. `expenses.community_id` â†’ `communities.id`
2. `expenses.created_by` â†’ `directus_users.id`
3. `expenses.approved_by` â†’ `directus_users.id`

### ç´¢å¼•ï¼ˆ4ä¸ªï¼‰

1. `idx_expenses_community_time` - (community_id, paid_at desc, id)
2. `idx_expenses_type_time` - (community_id, expense_type, paid_at desc)
3. `idx_expenses_period` - (period, community_id)
4. `idx_expenses_status` - (status, approved_at desc)

## åˆ›å»ºæ­¥éª¤

### æ­¥éª¤ 1: è®¾ç½®ç®¡ç†å‘˜ Token

```bash
export DIRECTUS_ADMIN_TOKEN="your_admin_token_here"
```

è·å– token çš„æ–¹æ³•ï¼š
1. ç™»å½• Directus Admin
2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
3. æŸ¥çœ‹ Network æ ‡ç­¾
4. æ‰¾åˆ°ä»»æ„ API è¯·æ±‚
5. å¤åˆ¶ Authorization header ä¸­çš„ Bearer token

### æ­¥éª¤ 2: è¿è¡Œåˆ›å»ºè„šæœ¬

```bash
bash scripts/create-expenses-table.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… åˆ›å»º expenses é›†åˆï¼ˆä½¿ç”¨ payments å›¾æ ‡ ğŸ’³ï¼‰
- âœ… åˆ›å»ºæ‰€æœ‰ 22 ä¸ªå­—æ®µ
- âœ… é…ç½®å­—æ®µç±»å‹ã€éªŒè¯è§„åˆ™ã€æ˜¾ç¤ºé€‰é¡¹
- âœ… åˆ›å»º 3 ä¸ªè¡¨å…³ç³»
- âœ… è®¾ç½®æ­£ç¡®çš„ meta é…ç½®ï¼ˆé singletonï¼Œé hiddenï¼‰

### æ­¥éª¤ 3: éªŒè¯åˆ›å»ºç»“æœ

#### åœ¨ Directus Admin ä¸­æ£€æŸ¥

1. è®¿é—® `http://localhost:8055/admin`
2. è¿›å…¥ Content â†’ Expenses
3. æ£€æŸ¥ï¼š
   - [ ] è¡¨å›¾æ ‡æ˜¾ç¤ºä¸º ğŸ’³ï¼ˆpaymentsï¼‰è€Œä¸æ˜¯æ–‡ä»¶å¤¹
   - [ ] å¯ä»¥ç‚¹å‡»è¿›å…¥æŸ¥çœ‹æ•°æ®
   - [ ] å­—æ®µåˆ—è¡¨å®Œæ•´ï¼ˆ22ä¸ªå­—æ®µï¼‰
   - [ ] å¯ä»¥åˆ›å»ºæ–°è®°å½•

#### æµ‹è¯•åˆ›å»ºè®°å½•

åœ¨ Directus Admin ä¸­åˆ›å»ºä¸€æ¡æµ‹è¯•è®°å½•ï¼š

```json
{
  "community_id": "<your_community_id>",
  "expense_type": "utilities",
  "title": "2024å¹´1æœˆç”µè´¹",
  "description": "å°åŒºå…¬å…±åŒºåŸŸç”µè´¹",
  "amount": 5000.00,
  "paid_at": "2024-01-15T10:00:00",
  "period": "2024-01",
  "payment_method": "bank",
  "status": "approved",
  "created_by": "<your_user_id>"
}
```

### æ­¥éª¤ 4: é…ç½®æƒé™

å¦‚æœè¿˜æ²¡æœ‰é…ç½®æƒé™ï¼Œè¿è¡Œæƒé™é…ç½®è„šæœ¬ï¼š

```bash
bash scripts/fix-resident-billing-permissions.sh
```

è¿™ä¼šä¸º resident è§’è‰²é…ç½®ï¼š
- âœ… expenses è¡¨çš„è¯»æƒé™ï¼ˆåªèƒ½è¯»å·²å®¡æ ¸çš„è®°å½•ï¼‰
- âœ… å…³è”è¡¨æƒé™ï¼ˆcommunities, directus_usersï¼‰

### æ­¥éª¤ 5: åœ¨åº”ç”¨ä¸­æµ‹è¯•

1. ä½¿ç”¨ resident ç”¨æˆ·ç™»å½•åº”ç”¨
2. è®¿é—® Profile é¡µé¢
3. ç‚¹å‡» "æŸ¥çœ‹å°åŒºæ”¶æ”¯æƒ…å†µ"
4. åº”è¯¥èƒ½çœ‹åˆ°ï¼š
   - æ€»æ”¶å…¥ã€æ€»æ”¯å‡ºã€ç»“ä½™
   - æ”¯å‡ºç»„æˆï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰
   - å¯ä»¥ç‚¹å‡»æŸ¥çœ‹æ”¯å‡ºæ˜ç»†

## å¸¸è§é—®é¢˜

### Q1: è„šæœ¬æ‰§è¡ŒæŠ¥é”™ï¼Ÿ

**æ£€æŸ¥é¡¹**:
1. DIRECTUS_ADMIN_TOKEN æ˜¯å¦æ­£ç¡®
2. Directus æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆ`http://localhost:8055`ï¼‰
3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
4. æŸ¥çœ‹ Directus æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥ Directus æœåŠ¡çŠ¶æ€
curl -s http://localhost:8055/server/health | jq

# æµ‹è¯• token æ˜¯å¦æœ‰æ•ˆ
curl -s http://localhost:8055/users/me \
  -H "Authorization: Bearer $DIRECTUS_ADMIN_TOKEN" | jq
```

### Q2: è¡¨åˆ›å»ºæˆåŠŸä½†ä»æ˜¾ç¤ºä¸ºæ–‡ä»¶å¤¹ï¼Ÿ

**åŸå› **: æµè§ˆå™¨ç¼“å­˜é—®é¢˜

**è§£å†³æ–¹æ³•**:
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. ä½¿ç”¨æ— ç—•æ¨¡å¼è®¿é—® Directus Admin
3. å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆCtrl+Shift+R æˆ– Cmd+Shift+Rï¼‰

### Q3: å­—æ®µåˆ›å»ºå¤±è´¥ï¼Ÿ

**åŸå› **: å¯èƒ½æŸäº›å­—æ®µå·²å­˜åœ¨æˆ–æœ‰å‘½åå†²çª

**è§£å†³æ–¹æ³•**:
1. åœ¨ Directus Admin ä¸­æ‰‹åŠ¨æ£€æŸ¥å­—æ®µåˆ—è¡¨
2. åˆ é™¤å†²çªçš„å­—æ®µ
3. é‡æ–°è¿è¡Œè„šæœ¬

### Q4: å…³ç³»åˆ›å»ºå¤±è´¥ï¼Ÿ

**åŸå› **: å…³è”è¡¨ä¸å­˜åœ¨æˆ–å­—æ®µç±»å‹ä¸åŒ¹é…

**è§£å†³æ–¹æ³•**:
1. ç¡®ä¿ communities è¡¨å­˜åœ¨
2. ç¡®ä¿ directus_users è¡¨å­˜åœ¨
3. æ£€æŸ¥å­—æ®µç±»å‹æ˜¯å¦ä¸º uuid

### Q5: åº”ç”¨ä¸­çœ‹ä¸åˆ°æ”¯å‡ºæ•°æ®ï¼Ÿ

**æ£€æŸ¥é¡¹**:
1. æƒé™æ˜¯å¦é…ç½®æ­£ç¡®
2. æ˜¯å¦æœ‰æµ‹è¯•æ•°æ®
3. æ•°æ®çš„ status æ˜¯å¦ä¸º approved
4. ç”¨æˆ·çš„ community_id æ˜¯å¦åŒ¹é…

**è§£å†³æ–¹æ³•**:
```bash
# 1. æ£€æŸ¥æƒé™
bash scripts/diagnose-billing-permissions.sh

# 2. ä¿®å¤æƒé™
bash scripts/fix-resident-billing-permissions.sh

# 3. åœ¨ Directus Admin ä¸­æ£€æŸ¥æ•°æ®
# è®¿é—® Content â†’ Expenses
# ç¡®ä¿æœ‰ status=approved çš„è®°å½•
```

## æ•°æ®è¿ç§»ï¼ˆå¦‚æœæœ‰æ—§æ•°æ®ï¼‰

å¦‚æœä¹‹å‰æœ‰ expenses æ•°æ®éœ€è¦è¿ç§»ï¼š

### æ­¥éª¤ 1: å¯¼å‡ºæ—§æ•°æ®

åœ¨åˆ é™¤æ—§è¡¨ä¹‹å‰ï¼Œåº”è¯¥å·²ç»å¯¼å‡ºäº†æ•°æ®ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ£€æŸ¥æ•°æ®åº“å¤‡ä»½ã€‚

### æ­¥éª¤ 2: è½¬æ¢æ•°æ®æ ¼å¼

æ ¹æ®æ–°è¡¨ç»“æ„è°ƒæ•´æ•°æ®æ ¼å¼ï¼š
- ç¡®ä¿æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½æœ‰å€¼
- æšä¸¾å€¼è¦åŒ¹é…æ–°çš„å®šä¹‰
- JSON å­—æ®µæ ¼å¼è¦æ­£ç¡®

### æ­¥éª¤ 3: å¯¼å…¥æ•°æ®

ä½¿ç”¨ Directus API æ‰¹é‡å¯¼å…¥ï¼š

```bash
# ç¤ºä¾‹ï¼šæ‰¹é‡åˆ›å»º expenses
curl -X POST "http://localhost:8055/items/expenses" \
  -H "Authorization: Bearer $DIRECTUS_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '[
    {
      "community_id": "uuid1",
      "expense_type": "utilities",
      "title": "ç”µè´¹",
      "amount": 5000,
      "paid_at": "2024-01-15T10:00:00",
      "payment_method": "bank",
      "status": "approved",
      "created_by": "uuid2"
    }
  ]'
```

## éªŒè¯æ¸…å•

åˆ›å»ºå®Œæˆåï¼Œä½¿ç”¨æ­¤æ¸…å•éªŒè¯ï¼š

### Directus Admin éªŒè¯
- [ ] expenses è¡¨æ˜¾ç¤ºä¸ºæ­£å¸¸å›¾æ ‡ï¼ˆğŸ’³ï¼‰
- [ ] å¯ä»¥ç‚¹å‡»è¿›å…¥æŸ¥çœ‹æ•°æ®
- [ ] å­—æ®µåˆ—è¡¨å®Œæ•´ï¼ˆ22ä¸ªå­—æ®µï¼‰
- [ ] å¯ä»¥åˆ›å»ºæ–°è®°å½•
- [ ] å¯ä»¥ç¼–è¾‘è®°å½•
- [ ] å¯ä»¥åˆ é™¤è®°å½•ï¼ˆè½¯åˆ é™¤ï¼‰
- [ ] å…³ç³»å­—æ®µæ˜¾ç¤ºæ­£ç¡®ï¼ˆcommunity_id, created_by, approved_byï¼‰

### API éªŒè¯
- [ ] å¯ä»¥è¯»å– expenses æ•°æ®
- [ ] å¯ä»¥åˆ›å»º expenses è®°å½•
- [ ] å¯ä»¥æ›´æ–° expenses è®°å½•
- [ ] æƒé™è¿‡æ»¤æ­£å¸¸å·¥ä½œ

### åº”ç”¨éªŒè¯
- [ ] è´¢åŠ¡æ€»è§ˆé¡µé¢æ˜¾ç¤ºæ”¯å‡ºæ•°æ®
- [ ] æ”¯å‡ºé‡‘é¢è®¡ç®—æ­£ç¡®
- [ ] æ”¯å‡ºåˆ†ç±»æ˜¾ç¤ºæ­£ç¡®
- [ ] å¯ä»¥æŸ¥çœ‹æ”¯å‡ºæ˜ç»†
- [ ] resident ç”¨æˆ·åªèƒ½çœ‹åˆ°å·²å®¡æ ¸çš„æ”¯å‡º

## ç›¸å…³æ–‡æ¡£

- [è´¢åŠ¡è¡¨ç»“æ„è®¾è®¡](./finance-schema-v2.dbml)
- [åˆ›å»ºè„šæœ¬](../../scripts/create-expenses-table.sh)
- [æƒé™é…ç½®æŒ‡å—](./permission-troubleshooting.md)
- [è´¢åŠ¡åŠŸèƒ½è®¾è®¡æ–‡æ¡£](./design.md)
